<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Noticias Positivas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="preconnect" href="https://script.google.com">
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="icon" href="./assets/logo.svg" type="image/svg+xml">

  <style>
    :root{
      --bg:#0f1115; --card:#171923; --text:#e6e7eb; --muted:#a9acb7; --chip:#2a2f3a; --accent:#6ee7b7;
      --gap:14px; --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:inherit}

    header{display:flex;align-items:center;gap:12px;padding:16px 18px;border-bottom:1px solid #262a36;position:sticky;top:0;background:linear-gradient(180deg, rgba(15,17,21,.96), rgba(15,17,21,.88));backdrop-filter: blur(6px);z-index:10}
    header img{height:36px;width:auto;cursor:pointer}
    header .brand{font-weight:700;letter-spacing:.2px}

    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .filters{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 2fr auto;gap:10px;align-items:center;margin:16px 0}
    .filters select,.filters input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2f3a;background:#0f1218;color:var(--text)}
    .filters button{padding:10px 14px;border-radius:10px;border:1px solid #2a2f3a;background:#1f2430;color:#fff;cursor:pointer}
    .filters button:hover{background:#262c3a}

    #empty{display:block;text-align:center;padding:18px;border:1px dashed #2b3140;border-radius:12px;color:var(--muted);margin-bottom:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(260px,1fr));gap:var(--gap)}
    .card{background:var(--card);border:1px solid #202433;border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;min-height:220px}
    .card .img{width:100%;height:150px;object-fit:cover;background:#0d0f14}
    .favicon-circle{width:100%;height:150px;display:flex;align-items:center;justify-content:center;background:#0d0f14}
    .favicon-circle img{width:48px;height:48px;border-radius:12px}
    .pad{padding:14px}
    .title{font-weight:700;margin-bottom:6px}
    .title a{text-decoration:none}
    .reason{color:var(--accent);font-size:.9rem;margin:0 0 8px 0}
    .meta{display:flex;flex-wrap:wrap;gap:6px;color:var(--muted);font-size:.8rem;margin-bottom:8px}
    .chip{background:var(--chip);border:1px solid #2f3544;padding:3px 8px;border-radius:999px}
    .excerpt{color:#cfd2dc;font-size:.95rem}

    .topbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .topbar .chip{cursor:pointer}

    @media (max-width:680px){
      .filters{grid-template-columns:1fr 1fr;grid-auto-rows:auto}
      .filters .wide{grid-column:1 / -1}
    }
  </style>
</head>
<body>
  <header>
    <img id="logoImg" src="./assets/logo.svg" alt="Logo (clic para ir al inicio)">
    <div class="brand">Noticias Positivas</div>
  </header>

  <div id="statsBar" class="wrap" style="margin-top:8px; color:#a9acb7;">&nbsp;</div>

  <main class="wrap">
    <div class="topbar">
      <button id="btnLater" class="chip">Ver ‚ÄúLeer despu√©s‚Äù</button>
      <!-- aqu√≠ podr√≠as a√±adir m√°s chips (ej. ‚ÄúTop hoy‚Äù) -->
    </div>

    <section class="filters">
      <select id="langSelect" aria-label="Idioma">
        <option value="">Todos los idiomas</option>
        <option value="es">Espa√±ol</option>
        <option value="en">Ingl√©s</option>
      </select>

      <!-- CATEGOR√çA din√°mica -->
      <select id="categorySelect" aria-label="Categor√≠a">
        <option value="">Todas las categor√≠as</option>
      </select>

      <select id="countrySelect" aria-label="Pa√≠s">
        <option value="">Todos los pa√≠ses</option>
        <option>Colombia</option>
        <option>M√©xico</option>
        <option>Argentina</option>
        <option>Per√∫</option>
        <option>Chile</option>
        <option>Espa√±a</option>
      </select>

      <select id="citySelect" aria-label="Ciudad">
        <option value="">Todas las ciudades</option>
        <option>Bogot√°</option>
        <option>Medell√≠n</option>
        <option>Ciudad de M√©xico</option>
        <option>Lima</option>
        <option>Santiago</option>
        <option>Madrid</option>
      </select>

      <input id="q" class="wide" type="search" placeholder="Buscar por t√≠tulo/fuente‚Ä¶">
      <button id="apply" type="button">Aplicar filtros</button>
    </section>

    <!-- Formulario ‚ÄúEnviar fuente‚Äù -->
    <form id="proposeForm" class="filters" style="grid-template-columns: 2fr 3fr 2fr auto; margin-top:0;">
      <input type="text" id="p_name" placeholder="Nombre de la fuente (visible)">
      <input type="url"  id="p_rss"  placeholder="URL RSS (https://...)">
      <input type="text" id="p_cat"  placeholder="Categor√≠a (opcional)">
      <button type="submit">Sugerir fuente</button>
    </form>
    <div id="proposeMsg" style="color:#a9acb7; margin:8px 0 16px 0;"></div>

    <div id="empty">Cargando noticias‚Ä¶</div>
    <section id="list" class="grid" aria-live="polite"></section>
  </main>

  <script>
    // ======== CONFIG ========
    const API_URL = "https://script.google.com/macros/s/AKfycbwmz6kGPilJDrrrc9NqUKXSxTfpMa2l1LHh7diriHo6nSjoliQMp_JtBHT9GDomtKqf/exec"; // <--- REEMPLAZA y deja las comillas

    const INITIAL_LIMIT = 24;
    const FULL_LIMIT    = 60;
    const REFRESH_MS    = 300000;  // 5 min

    // ======== IDENTIDAD AN√ìNIMA ========
    function uuidv4(){
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = crypto.getRandomValues(new Uint8Array(1))[0] & 15;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    const DEVICE_ID = (localStorage.getItem('np_device') || (() => {
      const id = uuidv4();
      localStorage.setItem('np_device', id);
      return id;
    })());

    // ======== PREFS (persistentes) ========
    const PREF_KEY = 'np_filters';
    function saveFilters(){
      const get = id => (document.getElementById(id)?.value || '').trim();
      const prefs = {
        language: get('langSelect'),
        category: get('categorySelect'),
        country:  get('countrySelect'),
        city:     get('citySelect'),
        q:        get('q')
      };
      localStorage.setItem(PREF_KEY, JSON.stringify(prefs));
    }
    function loadFilters(){
      try {
        const prefs = JSON.parse(localStorage.getItem(PREF_KEY) || '{}');
        Object.entries(prefs).forEach(([k,v]) => {
          const id = (k === 'q') ? 'q' : k + 'Select';
          const el = document.getElementById(id);
          if (el && typeof v === 'string') el.value = v;
        });
      } catch(e){}
    }

    // ======== LIKES (local) ========
    const LIKES_KEY = 'np_likes';
    function getLikesLocal(){ try{ return new Set(JSON.parse(localStorage.getItem(LIKES_KEY) || '[]')); }catch{ return new Set(); } }
    function setLikesLocal(set){ localStorage.setItem(LIKES_KEY, JSON.stringify(Array.from(set))); }

    // ======== LEER DESPU√âS ========
    const LATER_KEY = 'np_readLater'; // { [dedup]: expiryTimestamp }
    function getLater(){ try{ return JSON.parse(localStorage.getItem(LATER_KEY) || '{}'); }catch{ return {}; } }
    function setLater(obj){ localStorage.setItem(LATER_KEY, JSON.stringify(obj)); }
    function cleanupLater(){
      const now = Date.now();
      const obj = getLater();
      let changed = false;
      Object.keys(obj).forEach(k => { if (Number(obj[k]) < now) { delete obj[k]; changed = true; }});
      if (changed) setLater(obj);
    }
    cleanupLater();

    // ======== UTILIDADES UI ========
    let lastSeenUpdate = null;
    let inFlightController = null;
    let applyTimer = null;

    function resetFiltersToHome(){
      const ids = ['langSelect','categorySelect','countrySelect','citySelect','q'];
      ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
      lastSeenUpdate = null;
      saveFilters();
      applyFilters({ fullReload: true });
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    (function initLogo(){
      const img = document.getElementById('logoImg');
      if (!img) return;
      const saved = localStorage.getItem('np_logo');
      if (saved) img.src = saved;
      img.addEventListener('click', () => resetFiltersToHome());
    })();

    function getFavicon(url){
      try { return `https://www.google.com/s2/favicons?domain=${new URL(url).origin}&sz=128`; }
      catch { return 'https://via.placeholder.com/128x128.png?text=No+Image'; }
    }

    function twoSentences(s=''){
      let t = String(s)
        .replace(/<script[\s\S]*?<\/script>/gi,' ')
        .replace(/<style[\s\S]*?<\/style>/gi,' ')
        .replace(/<figure[\s\S]*?<\/figure>/gi,' ')
        .replace(/<[^>]*>/g,' ')
        .replace(/\s+/g,' ')
        .trim();
      const parts = t.split(/(?<=[.!?])\s+/);
      const clipped = parts.slice(0,2).join(' ');
      return clipped.length > 240 ? clipped.slice(0,237)+'‚Ä¶' : clipped;
    }

    function parseSheetDate(x){
      if (x === null || x === undefined) return null;
      const d1 = new Date(x);
      if (!isNaN(d1)) return d1;
      const n = Number(x);
      if (!isNaN(n)) {
        const ms = (n - 25569) * 86400000;
        const d2 = new Date(ms);
        if (!isNaN(d2)) return d2;
      }
      return null;
    }

    function sortNewest(items){
      return [...items].sort((a,b) => {
        const da = parseSheetDate(a.published_at) || new Date(0);
        const db = parseSheetDate(b.published_at) || new Date(0);
        return db - da;
      });
    }

    async function fetchNews({ filters = {}, since = null, q = '', limit = INITIAL_LIMIT } = {}){
      if (inFlightController) inFlightController.abort();
      inFlightController = new AbortController();

      const params = new URLSearchParams({
        limit: String(limit),
        min: '10',
        fallback: '1',
        t: Date.now().toString()
      });
      if (filters.language) params.append('language', filters.language);
      if (filters.category) params.append('category', filters.category);
      if (filters.country)  params.append('country',  filters.country);
      if (filters.city)     params.append('city',     filters.city);
      if (since)            params.append('since',    since);
      if (q)                params.append('q',        q);

      const res = await fetch(`${API_URL}?${params.toString()}`, {
        cache: 'no-store',
        signal: inFlightController.signal
      });
      if (!res.ok) throw new Error(`API error: ${res.status}`);
      return await res.json();
    }

    async function fetchCategories(){
      const url = `${API_URL}?fn=categories&t=${Date.now()}`;
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('No se pudieron cargar las categor√≠as');
      return res.json(); // { categories: [...], last_updated: ... }
    }

    function populateCategorySelect(categories){
      const sel = document.getElementById('categorySelect');
      if (!sel) return;
      const current = sel.value;
      sel.innerHTML = `<option value="">Todas las categor√≠as</option>`;
      (categories || []).forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
      });
      if (current && [...sel.options].some(o => o.value.toLowerCase() === current.toLowerCase())) {
        sel.value = current;
      }
    }

    function fmtDate(d){
      const dt = parseSheetDate(d);
      return !dt ? '' : dt.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'2-digit'});
    }

    function createCard(it){
      const hasImg  = it.image && String(it.image).trim();
      const imgHtml = hasImg
        ? `<img class="img" src="${it.image}" alt="" loading="lazy">`
        : `<div class="favicon-circle"><img src="${getFavicon(it.url)}" alt=""></div>`;

      const chipCat  = it.category ? `<span class="chip">${it.category}</span>` : '';
      const chipLang = it.language ? `<span class="chip">${String(it.language).toUpperCase()}</span>` : '';
      const chipLoc  = it.country ? `<span class="chip">${it.country}${it.city ? ' ¬∑ ' + it.city : ''}</span>` : '';
      const source   = it.source ? `<span>${it.source}</span>` : '';
      const pub      = it.published_at ? `<span>${fmtDate(it.published_at)}</span>` : '';
      const excerpt  = twoSentences(it.summary || '');

      const card = document.createElement('article');
      card.className = 'card';
      card.innerHTML = `
        ${imgHtml}
        <div class="pad">
          <div class="title">
            <a href="${it.url}" target="_blank" rel="noopener" style="color:inherit;text-decoration:none;">
              ${it.title || ''}
            </a>
          </div>
          <div class="reason">${it.positivity_reason || ''}</div>
          <div class="meta">${chipCat} ${chipLang} ${chipLoc} ${source} ${pub}</div>
          <div class="excerpt">${excerpt}</div>
        </div>
      `;

      // acciones
      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.gap = '10px';
      actions.style.marginTop = '10px';

      // Compartir
      const shareBtn = document.createElement('button');
      shareBtn.textContent = 'Compartir';
      shareBtn.className = 'chip';
      shareBtn.onclick = async () => {
        const text = `${it.title} ‚Äî ${it.source || ''}`;
        const url  = it.url;
        try {
          if (navigator.share) {
            await navigator.share({ title: it.title, text, url });
          } else {
            const wa = `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`;
            window.open(wa, '_blank');
          }
        } catch (e) {}
      };
      actions.appendChild(shareBtn);

      // Like
      const likesLocal = getLikesLocal();
      const liked = likesLocal.has(it.dedup || it.url);
      const likeBtn = document.createElement('button');
      likeBtn.textContent = liked ? '‚ù§Ô∏è Te gusta' : 'ü§ç Me gusta';
      likeBtn.className = 'chip';
      likeBtn.onclick = async () => {
        const key = it.dedup || it.url;
        const nowSet = getLikesLocal();
        if (nowSet.has(key)) return;
        nowSet.add(key);
        setLikesLocal(nowSet);
        likeBtn.textContent = '‚ù§Ô∏è Te gusta';
        const params = new URLSearchParams({
          fn: 'like',
          dedup: key,
          url: it.url,
          title: it.title || '',
          source: it.source || '',
          device: DEVICE_ID,
          t: Date.now().toString()
        });
        fetch(`${API_URL}?${params.toString()}`, { method: 'GET', cache: 'no-store' }).catch(()=>{});
      };
      actions.appendChild(likeBtn);

      // Leer despu√©s (24h)
      const laterBtn = document.createElement('button');
      laterBtn.textContent = 'üìå Leer despu√©s';
      laterBtn.className = 'chip';
      laterBtn.onclick = () => {
        const obj = getLater();
        const key = it.dedup || it.url;
        const until = Date.now() + 24*60*60*1000;
        obj[key] = until;
        setLater(obj);
        laterBtn.textContent = 'üìå Guardado (24h)';
      };
      actions.appendChild(laterBtn);

      card.querySelector('.pad').appendChild(actions);
      return card;
    }

    async function renderIncremental(items, q=''){
      const list  = document.getElementById('list');
      const empty = document.getElementById('empty');
      if (!list || !empty) return;

      list.innerHTML = '';
      const filtered = q ? items.filter(it => (it.title||'').toLowerCase().includes(q.toLowerCase())) : items;

      if (!filtered.length) {
        empty.style.display = 'block';
        empty.textContent = 'No hay resultados con este filtro.';
        return;
      }
      empty.style.display = 'none';

      const BATCH = 8;
      for (let i = 0; i < filtered.length; i++){
        list.appendChild(createCard(filtered[i]));
        if ((i+1) % BATCH === 0) {
          await new Promise(r => requestAnimationFrame(r));
        }
      }
    }

    async function applyFilters({ fullReload = false } = {}){
      try {
        const get = (id) => (document.getElementById(id)?.value || '').trim();
        const filters = {
          language: get('langSelect'),
          category: get('categorySelect'),
          country:  get('countrySelect'),
          city:     get('citySelect')
        };
        const q = get('q');
        saveFilters();

        const quick = await fetchNews({
          filters,
          since: (!fullReload && lastSeenUpdate) ? lastSeenUpdate : null,
          q,
          limit: INITIAL_LIMIT
        });

        if (!lastSeenUpdate || quick.last_updated !== lastSeenUpdate || fullReload){
          const quickSorted = sortNewest(quick.items || []);
          await renderIncremental(quickSorted, q);
          lastSeenUpdate = quick.last_updated;
        }

        const full = await fetchNews({ filters, q, limit: FULL_LIMIT });
        const fullSorted = sortNewest(full.items || []);
        await renderIncremental(fullSorted, q);

      } catch (err){
        if (err.name === 'AbortError') return;
        console.error(err);
        const empty = document.getElementById('empty');
        if (empty){
          empty.style.display = 'block';
          empty.textContent = 'No pudimos cargar la API. Revisa la conexi√≥n.';
        }
      }
    }

    function scheduleApply(){
      if (applyTimer) clearTimeout(applyTimer);
      applyTimer = setTimeout(() => applyFilters({ fullReload: true }), 2000); // auto 2s
    }

    async function refreshStatsBar(){
      const statsEl = document.getElementById('statsBar');
      if (!statsEl) return;
      const streak = Number(localStorage.getItem('np_streak')||0);
      const total  = Number(localStorage.getItem('np_totalDays')||0);
      let visitors = '‚Ä¶';
      try {
        const res = await fetch(`${API_URL}?fn=stats&t=${Date.now()}`, { cache:'no-store' });
        const json = await res.json();
        visitors = json.visitors_today ?? '‚Ä¶';
      } catch {}
      statsEl.textContent = `Haciendo feliz a ${visitors} personas hoy ¬∑ Tu racha: ${streak} d√≠as ¬∑ Has venido ${total} d√≠as en total`;
    }

    // ======== Racha de lectura ========
    const STREAK_KEY = 'np_streak';
    const LAST_KEY   = 'np_lastVisit';
    const TOTAL_KEY  = 'np_totalDays';

    function updateStreak(){
      const todayStr = new Date().toDateString();
      const last = localStorage.getItem(LAST_KEY);
      let streak = Number(localStorage.getItem(STREAK_KEY) || 0);
      let total  = Number(localStorage.getItem(TOTAL_KEY) || 0);

      if (last !== todayStr) {
        total += 1;
        const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
        streak = (last === yesterday.toDateString()) ? (streak + 1) : 1;
        localStorage.setItem(LAST_KEY, todayStr);
        localStorage.setItem(STREAK_KEY, String(streak));
        localStorage.setItem(TOTAL_KEY, String(total));
      }
      return { streak, total };
    }

    // ======== Eventos iniciales ========
    document.addEventListener('DOMContentLoaded', async () => {
      // Ping de visita
      (async () => {
        const params = new URLSearchParams({ fn:'visit', device: DEVICE_ID, t: Date.now().toString() });
        fetch(`${API_URL}?${params.toString()}`, { method:'GET', cache:'no-store' }).catch(()=>{});
      })();

      updateStreak();

      // Cargar categor√≠as din√°micas antes de aplicar filtros
      try {
        const { categories } = await fetchCategories();
        populateCategorySelect(categories || []);
      } catch(e) {
        console.warn('No se pudieron cargar categor√≠as din√°micas:', e);
      }

      // cargar preferencias guardadas
      loadFilters();

      // Listeners para auto-aplicar + guardar prefs
      ['langSelect','categorySelect','countrySelect','citySelect','q'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const ev = (id === 'q') ? 'input' : 'change';
        el.addEventListener(ev, () => { saveFilters(); scheduleApply(); });
      });

      // Bot√≥n aplicar
      const btn = document.getElementById('apply');
      if (btn) btn.addEventListener('click', () => applyFilters({ fullReload: true }));

      // Proponer fuente
      const form = document.getElementById('proposeForm');
      const msg  = document.getElementById('proposeMsg');
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const name = document.getElementById('p_name').value.trim();
          const rss  = document.getElementById('p_rss').value.trim();
          const cat  = document.getElementById('p_cat').value.trim();
          if (!name || !rss) { msg.textContent = 'Completa nombre y URL RSS.'; return; }
          const params = new URLSearchParams({ fn:'propose_source', name, rss_url:rss, category:cat, t:Date.now().toString() });
          try {
            const res = await fetch(`${API_URL}?${params.toString()}`, { method:'GET', cache:'no-store' });
            if (!res.ok) throw new Error('fail');
            msg.textContent = '¬°Gracias! Revisaremos tu fuente.';
            form.reset();
          } catch {
            msg.textContent = 'No pudimos enviar la propuesta ahora.';
          }
          setTimeout(()=> msg.textContent='', 4000);
        });
      }

      // Ver ‚ÄúLeer despu√©s‚Äù
      document.getElementById('btnLater')?.addEventListener('click', async () => {
        cleanupLater();
        const map = getLater();
        const keys = new Set(Object.keys(map));
        try {
          const res = await fetch(`${API_URL}?limit=200&t=${Date.now()}`, { cache:'no-store' });
          const json = await res.json();
          const items = (json.items || []).filter(it => keys.has(it.dedup || it.url));
          await renderIncremental(items, '');
          window.scrollTo({ top: 0, behavior: 'smooth' });
        } catch {}
      });

      // Primera carga y refrescos
      await applyFilters({ fullReload: true });
      setInterval(() => applyFilters({ fullReload: false }), REFRESH_MS);

      // Stats bar
      refreshStatsBar();
      setInterval(refreshStatsBar, 120000);
    });
  </script>
</body>
</html>
