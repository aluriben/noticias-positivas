<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Noticias Positivas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="preconnect" href="https://script.google.com">
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="icon" href="./assets/logo.svg" type="image/svg+xml">

  <style>
    :root{
      --bg:#0f1115; --card:#171923; --text:#e6e7eb; --muted:#a9acb7; --chip:#2a2f3a; --accent:#6ee7b7;
      --gap:14px; --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:inherit}

    header{display:flex;align-items:center;gap:12px;padding:16px 18px;border-bottom:1px solid #262a36;position:sticky;top:0;background:linear-gradient(180deg, rgba(15,17,21,.96), rgba(15,17,21,.88));backdrop-filter: blur(6px);z-index:10}
    header img{height:36px;width:auto;cursor:pointer}
    header .brand{font-weight:700;letter-spacing:.2px}

    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .filters{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 2fr auto;gap:10px;align-items:center;margin-bottom:16px}
    .filters select,.filters input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2f3a;background:#0f1218;color:var(--text)}
    .filters button{padding:10px 14px;border-radius:10px;border:1px solid #2a2f3a;background:#1f2430;color:#fff;cursor:pointer}
    .filters button:hover{background:#262c3a}

    #empty{display:block;text-align:center;padding:18px;border:1px dashed #2b3140;border-radius:12px;color:var(--muted);margin-bottom:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(260px,1fr));gap:var(--gap)}
    .card{background:var(--card);border:1px solid #202433;border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;min-height:220px}
    .card .img{width:100%;height:150px;object-fit:cover;background:#0d0f14}
    .favicon-circle{width:100%;height:150px;display:flex;align-items:center;justify-content:center;background:#0d0f14}
    .favicon-circle img{width:48px;height:48px;border-radius:12px}
    .pad{padding:14px}
    .title{font-weight:700;margin-bottom:6px}
    .title a{text-decoration:none}
    .reason{color:var(--accent);font-size:.9rem;margin:0 0 8px 0}
    .meta{display:flex;flex-wrap:wrap;gap:6px;color:var(--muted);font-size:.8rem;margin-bottom:8px}
    .chip{background:var(--chip);border:1px solid #2f3544;padding:3px 8px;border-radius:999px}
    .excerpt{color:#cfd2dc;font-size:.95rem}

    @media (max-width:680px){
      .filters{grid-template-columns:1fr 1fr;grid-auto-rows:auto}
      .filters .wide{grid-column:1 / -1}
    }
  </style>
</head>
<body>
  <header>
    <img id="logoImg" src="./assets/logo.svg" alt="Logo (clic para ir al inicio)">
    <div class="brand">Noticias Positivas</div>
  </header>

  <main class="wrap">
    <section class="filters">
      <select id="langSelect" aria-label="Idioma">
        <option value="">Todos los idiomas</option>
        <option value="es">Español</option>
        <option value="en">Inglés</option>
      </select>

      <!-- CATEGORÍA: ahora se pobla dinámicamente -->
      <select id="categorySelect" aria-label="Categoría">
        <option value="">Todas las categorías</option>
      </select>

      <select id="countrySelect" aria-label="País">
        <option value="">Todos los países</option>
        <option>Colombia</option>
        <option>México</option>
        <option>Argentina</option>
        <option>Perú</option>
        <option>Chile</option>
        <option>España</option>
      </select>

      <select id="citySelect" aria-label="Ciudad">
        <option value="">Todas las ciudades</option>
        <option>Bogotá</option>
        <option>Medellín</option>
        <option>Ciudad de México</option>
        <option>Lima</option>
        <option>Santiago</option>
        <option>Madrid</option>
      </select>

      <input id="q" class="wide" type="search" placeholder="Buscar por título/fuente…">
      <button id="apply" type="button">Aplicar filtros</button>
    </section>

    <div id="empty">Cargando noticias…</div>
    <section id="list" class="grid" aria-live="polite"></section>
  </main>

  <script>
    // 1) PON AQUÍ tu URL de la Web App de Google Apps Script (termina en /exec)
    const API_URL = "https://script.google.com/macros/s/AKfycbxyjyGlbkSBZWjIwRhvNrSI_m6ulQRkF0QliM7etZGd_OF3irPorAUI9Xloxxr7W2Q0/exec"; // <-- reemplaza por la tuya

    // Carga y refresco
    const INITIAL_LIMIT = 24;
    const FULL_LIMIT    = 60;
    const REFRESH_MS    = 300000;  // 5 min

    let lastSeenUpdate = null;
    let inFlightController = null;
    let applyTimer = null; // para auto-aplicar tras cambios (debounce 2s)

    function resetFiltersToHome(){
      const ids = ['langSelect','categorySelect','countrySelect','citySelect','q'];
      ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
      lastSeenUpdate = null;
      applyFilters({ fullReload: true });
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    (function initLogo(){
      const img = document.getElementById('logoImg');
      if (!img) return;
      const saved = localStorage.getItem('np_logo');
      if (saved) img.src = saved;
      img.addEventListener('click', () => resetFiltersToHome());
    })();

    function getFavicon(url){
      try { return `https://www.google.com/s2/favicons?domain=${new URL(url).origin}&sz=128`; }
      catch { return 'https://via.placeholder.com/128x128.png?text=No+Image'; }
    }

    function twoSentences(s=''){
      let t = String(s)
        .replace(/<script[\s\S]*?<\/script>/gi,' ')
        .replace(/<style[\s\S]*?<\/style>/gi,' ')
        .replace(/<figure[\s\S]*?<\/figure>/gi,' ')
        .replace(/<[^>]*>/g,' ')
        .replace(/\s+/g,' ')
        .trim();
      const parts = t.split(/(?<=[.!?])\s+/);
      const clipped = parts.slice(0,2).join(' ');
      return clipped.length > 240 ? clipped.slice(0,237)+'…' : clipped;
    }

    function parseSheetDate(x){
      if (x === null || x === undefined) return null;
      const d1 = new Date(x);
      if (!isNaN(d1)) return d1;
      const n = Number(x);
      if (!isNaN(n)) {
        const ms = (n - 25569) * 86400000;
        const d2 = new Date(ms);
        if (!isNaN(d2)) return d2;
      }
      return null;
    }

    function sortNewest(items){
      return [...items].sort((a,b) => {
        const da = parseSheetDate(a.published_at) || new Date(0);
        const db = parseSheetDate(b.published_at) || new Date(0);
        return db - da;
      });
    }

    async function fetchNews({ filters = {}, since = null, q = '', limit = INITIAL_LIMIT } = {}){
      if (inFlightController) inFlightController.abort();
      inFlightController = new AbortController();

      const params = new URLSearchParams({
        limit: String(limit),
        min: '10',
        fallback: '1',
        t: Date.now().toString()
      });
      if (filters.language) params.append('language', filters.language);
      if (filters.category) params.append('category', filters.category);
      if (filters.country)  params.append('country',  filters.country);
      if (filters.city)     params.append('city',     filters.city);
      if (since)            params.append('since',    since);
      if (q)                params.append('q',        q);

      const res = await fetch(`${API_URL}?${params.toString()}`, {
        cache: 'no-store',
        signal: inFlightController.signal
      });
      if (!res.ok) throw new Error(`API error: ${res.status}`);
      return await res.json();
    }

    async function fetchCategories(){
      const url = `${API_URL}?fn=categories&t=${Date.now()}`;
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('No se pudieron cargar las categorías');
      return res.json(); // { categories: [...], last_updated: ... }
    }

    function populateCategorySelect(categories){
      const sel = document.getElementById('categorySelect');
      if (!sel) return;
      const current = sel.value;
      sel.innerHTML = `<option value="">Todas las categorías</option>`;
      (categories || []).forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;        // usa el texto exacto que devuelve el backend
        opt.textContent = c;
        sel.appendChild(opt);
      });
      if (current && [...sel.options].some(o => o.value.toLowerCase() === current.toLowerCase())) {
        sel.value = current;
      }
    }

    function fmtDate(d){
      const dt = parseSheetDate(d);
      return !dt ? '' : dt.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'2-digit'});
    }

    function createCard(it){
      const hasImg  = it.image && String(it.image).trim();
      const imgHtml = hasImg
        ? `<img class="img" src="${it.image}" alt="" loading="lazy">`
        : `<div class="favicon-circle"><img src="${getFavicon(it.url)}" alt=""></div>`;

      const chipCat  = it.category ? `<span class="chip">${it.category}</span>` : '';
      const chipLang = it.language ? `<span class="chip">${String(it.language).toUpperCase()}</span>` : '';
      const chipLoc  = it.country ? `<span class="chip">${it.country}${it.city ? ' · ' + it.city : ''}</span>` : '';
      const source   = it.source ? `<span>${it.source}</span>` : '';
      const pub      = it.published_at ? `<span>${fmtDate(it.published_at)}</span>` : '';
      const excerpt  = twoSentences(it.summary || '');

      const card = document.createElement('article');
      card.className = 'card';
      card.innerHTML = `
        ${imgHtml}
        <div class="pad">
          <div class="title">
            <a href="${it.url}" target="_blank" rel="noopener" style="color:inherit;text-decoration:none;">
              ${it.title || ''}
            </a>
          </div>
          <div class="reason">${it.positivity_reason || ''}</div>
          <div class="meta">
            ${chipCat} ${chipLang} ${chipLoc} ${source} ${pub}
          </div>
          <div class="excerpt">${excerpt}</div>
        </div>
      `;
      return card;
    }

    async function renderIncremental(items, q=''){
      const list  = document.getElementById('list');
      const empty = document.getElementById('empty');
      if (!list || !empty) return;

      list.innerHTML = '';
      const filtered = q ? items.filter(it => (it.title||'').toLowerCase().includes(q.toLowerCase())) : items;

      if (!filtered.length) {
        empty.style.display = 'block';
        empty.textContent = 'No hay resultados con este filtro.';
        return;
      }
      empty.style.display = 'none';

      const BATCH = 8;
      for (let i = 0; i < filtered.length; i++){
        list.appendChild(createCard(filtered[i]));
        if ((i+1) % BATCH === 0) {
          await new Promise(r => requestAnimationFrame(r));
        }
      }
    }

    async function applyFilters({ fullReload = false } = {}){
      try {
        const get = (id) => (document.getElementById(id)?.value || '').trim();
        const filters = {
          language: get('langSelect'),
          category: get('categorySelect'),
          country:  get('countrySelect'),
          city:     get('citySelect')
        };
        const q = get('q');

        const quick = await fetchNews({
          filters,
          since: (!fullReload && lastSeenUpdate) ? lastSeenUpdate : null,
          q,
          limit: INITIAL_LIMIT
        });

        if (!lastSeenUpdate || quick.last_updated !== lastSeenUpdate || fullReload){
          const quickSorted = sortNewest(quick.items || []);
          await renderIncremental(quickSorted, q);
          lastSeenUpdate = quick.last_updated;
        }

        const full = await fetchNews({ filters, q, limit: FULL_LIMIT });
        const fullSorted = sortNewest(full.items || []);
        await renderIncremental(fullSorted, q);

      } catch (err){
        if (err.name === 'AbortError') return;
        console.error(err);
        const empty = document.getElementById('empty');
        if (empty){
          empty.style.display = 'block';
          empty.textContent = 'No pudimos cargar la API. Revisa la conexión.';
        }
      }
    }

    function scheduleApply(){
      if (applyTimer) clearTimeout(applyTimer);
      applyTimer = setTimeout(() => applyFilters({ fullReload: true }), 2000); // auto-aplica a los 2s
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // 1) Cargar categorías reales desde el backend y poblar el select
      try {
        const { categories } = await fetchCategories();
        populateCategorySelect(categories || []);
      } catch(e) {
        console.warn('No se pudieron cargar categorías dinámicas:', e);
      }

      // 2) Auto-aplicar filtros (debounce 2s) al cambiar cualquier selector o la búsqueda
      ['langSelect','categorySelect','countrySelect','citySelect','q'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const ev = (id === 'q') ? 'input' : 'change';
        el.addEventListener(ev, scheduleApply);
      });

      // 3) Botón "Aplicar filtros" sigue funcionando como acción inmediata
      const btn = document.getElementById('apply');
      if (btn) btn.addEventListener('click', () => applyFilters({ fullReload: true }));

      // 4) Carga inicial + refresco periódico
      applyFilters({ fullReload: true });
      setInterval(() => applyFilters({ fullReload: false }), REFRESH_MS);
    });
  </script>
</body>
</html>
