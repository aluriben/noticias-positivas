<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Noticias Positivas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="preconnect" href="https://script.google.com">
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="icon" href="./assets/logo.svg" type="image/svg+xml">

  <style>
    :root{
      --bg:#0f1115; --card:#171923; --text:#e6e7eb; --muted:#a9acb7; --chip:#2a2f3a; --accent:#6ee7b7;
      --gap:14px; --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:inherit}

    header{display:flex;align-items:center;gap:12px;padding:16px 18px;border-bottom:1px solid #262a36;position:sticky;top:0;background:linear-gradient(180deg, rgba(15,17,21,.96), rgba(15,17,21,.88));backdrop-filter: blur(6px);z-index:10}
    header img{height:36px;width:auto;cursor:pointer}
    header .brand{font-weight:700;letter-spacing:.2px}

    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .filters{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 2fr auto;gap:10px;align-items:center;margin:16px 0}
    .filters select,.filters input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2f3a;background:#0f1218;color:var(--text)}
    .filters button{padding:10px 14px;border-radius:10px;border:1px solid #2a2f3a;background:#1f2430;color:#fff;cursor:pointer}
    .filters button:hover{background:#262c3a}

    #empty{display:block;text-align:center;padding:18px;border:1px dashed #2b3140;border-radius:12px;color:var(--muted);margin-bottom:14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(260px,1fr));gap:var(--gap)}
    .card{background:var(--card);border:1px solid #202433;border-radius:var(--radius);overflow:hidden;display:flex;flex-direction:column;min-height:220px}
    .card .img{width:100%;height:150px;object-fit:cover;background:#0d0f14}
    .favicon-circle{width:100%;height:150px;display:flex;align-items:center;justify-content:center;background:#0d0f14}
    .favicon-circle img{width:48px;height:48px;border-radius:12px}
    .pad{padding:14px}
    .title{font-weight:700;margin-bottom:6px}
    .title a{text-decoration:none}
    .reason{color:var(--accent);font-size:.9rem;margin:0 0 8px 0}
    .meta{display:flex;flex-wrap:wrap;gap:6px;color:var(--muted);font-size:.8rem;margin-bottom:8px}
    .chip{background:var(--chip);border:1px solid #2f3544;padding:3px 8px;border-radius:999px}
    .excerpt{color:#cfd2dc;font-size:.95rem}

    .topbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .topbar .chip{cursor:pointer}

    footer{margin:28px auto 40px auto; text-align:center; color:var(--muted)}

    @media (max-width:980px){
      .filters{grid-template-columns:1fr 1fr 1fr;grid-auto-rows:auto}
      .filters .wide{grid-column:1 / -1}
      .filters .long{grid-column:1 / -1}
    }
  </style>
</head>
<body>
  <header>
    <img id="logoImg" src="./assets/logo.svg" alt="Logo (clic para ir al inicio)">
    <div class="brand">Noticias Positivas</div>
  </header>

  <!-- Barra de racha / total usuario -->
  <div class="wrap" style="margin-top:8px; color:#a9acb7;" id="userBar">
    Has visto Noticias Positivas: <b id="daysTotal">0</b> días en total · <b id="daysStreak">0</b> días seguidos
  </div>

  <main class="wrap">
    <div class="topbar">
      <button id="btnLater" class="chip">Ver “Leer después”</button>
      <button id="btnBackAll" class="chip" style="display:none;">Volver a todas las noticias</button>
    </div>

    <section class="filters">
      <select id="langSelect" aria-label="Idioma">
        <option value="">Todos los idiomas</option>
        <option value="es">Español</option>
        <option value="en">Inglés</option>
      </select>

      <!-- CATEGORÍA dinámica -->
      <select id="categorySelect" aria-label="Categoría">
        <option value="">Todas las categorías</option>
      </select>

      <!-- NUEVO: multi-select de fuentes -->
      <select id="sourcesSelect" aria-label="Fuentes" multiple class="long" title="Selecciona una o varias fuentes">
        <!-- se llena dinámicamente -->
      </select>

      <select id="countrySelect" aria-label="País">
        <option value="">Todos los países</option>
        <option>Colombia</option>
        <option>México</option>
        <option>Argentina</option>
        <option>Perú</option>
        <option>Chile</option>
        <option>España</option>
      </select>

      <select id="citySelect" aria-label="Ciudad">
        <option value="">Todas las ciudades</option>
        <option>Bogotá</option>
        <option>Medellín</option>
        <option>Ciudad de México</option>
        <option>Lima</option>
        <option>Santiago</option>
        <option>Madrid</option>
      </select>

      <input id="q" class="wide" type="search" placeholder="Buscar por título/fuente…">
      <button id="apply" type="button">Aplicar filtros</button>
    </section>

    <!-- Sugerir fuente (copy nuevo) -->
    <div class="filters" style="grid-template-columns: 3fr 1fr; margin-top:0;">
      <input id="p_rss" type="url" placeholder="¿No ves tu fuente favorita? Pega aquí la URL RSS (https://…)" class="long">
      <button id="btnSuggest" type="button">Sugerir fuente</button>
    </div>
    <div id="proposeMsg" style="color:#a9acb7; margin:8px 0 16px 0;"></div>

    <div id="empty">Cargando noticias…</div>
    <section id="list" class="grid" aria-live="polite"></section>
  </main>

  <footer>
    <div id="happyBar">Haciendo feliz a 0 personas (total histórico)</div>
  </footer>

  <script>
    // ======== CONFIG ========
    const API_URL = "https://script.google.com/macros/s/AKfycbxaq4Lv3AsxTt14_wjNgKFj6t97-grEd31urD9NJORVTKAy4BFnj_SsZpvChbXVm7C1/exec"; // <-- cámbiala y deja comillas
    const INITIAL_LIMIT = 24;
    const FULL_LIMIT    = 60;
    const REFRESH_MS    = 300000;  // 5 min

    // ======== IDENTIDAD ANÓNIMA ========
    function uuidv4(){
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = crypto.getRandomValues(new Uint8Array(1))[0] & 15;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    const DEVICE_ID = (localStorage.getItem('np_device') || (() => {
      const id = uuidv4();
      localStorage.setItem('np_device', id);
      return id;
    })());

    // ======== PREFS (persistentes) ========
    const PREF_KEY = 'np_filters';
    function saveFilters(){
      const get = id => (document.getElementById(id)?.value || '').trim();
      const prefs = {
        language: get('langSelect'),
        category: get('categorySelect'),
        country:  get('countrySelect'),
        city:     get('citySelect'),
        q:        get('q'),
        sources:  Array.from(document.getElementById('sourcesSelect')?.selectedOptions || []).map(o=>o.value)
      };
      localStorage.setItem(PREF_KEY, JSON.stringify(prefs));
    }
    function loadFilters(){
      try {
        const prefs = JSON.parse(localStorage.getItem(PREF_KEY) || '{}');
        const map = { language:'langSelect', category:'categorySelect', country:'countrySelect', city:'citySelect', q:'q' };
        Object.entries(map).forEach(([k,id]) => {
          const el = document.getElementById(id);
          if (el && typeof prefs[k] === 'string') el.value = prefs[k];
        });
        if (Array.isArray(prefs.sources)) {
          const sel = document.getElementById('sourcesSelect');
          if (sel) {
            Array.from(sel.options).forEach(o => { o.selected = prefs.sources.includes(o.value); });
          }
        }
      } catch(e){}
    }

    // ======== LIKES (local) ========
    const LIKES_KEY = 'np_likes';
    function getLikesLocal(){ try{ return new Set(JSON.parse(localStorage.getItem(LIKES_KEY) || '[]')); }catch{ return new Set(); } }
    function setLikesLocal(set){ localStorage.setItem(LIKES_KEY, JSON.stringify(Array.from(set))); }

    // ======== LEER DESPUÉS ========
    const LATER_KEY = 'np_readLater'; // { [dedup]: expiryTimestamp }
    function getLater(){ try{ return JSON.parse(localStorage.getItem(LATER_KEY) || '{}'); }catch{ return {}; } }
    function setLater(obj){ localStorage.setItem(LATER_KEY, JSON.stringify(obj)); }
    function cleanupLater(){
      const now = Date.now();
      const obj = getLater();
      let changed = false;
      Object.keys(obj).forEach(k => { if (Number(obj[k]) < now) { delete obj[k]; changed = true; }});
      if (changed) setLater(obj);
    }
    cleanupLater();

    // ======== UTILIDADES ========
    let lastSeenUpdate = null;
    let inFlightController = null;
    let applyTimer = null;
    let inLaterView = false;

    function resetFiltersToHome(){
      const ids = ['langSelect','categorySelect','countrySelect','citySelect','q'];
      ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
      const sel = document.getElementById('sourcesSelect');
      if (sel) Array.from(sel.options).forEach(o => o.selected = false);
      lastSeenUpdate = null;
      inLaterView = false;
      document.getElementById('btnBackAll').style.display = 'none';
      saveFilters();
      applyFilters({ fullReload: true });
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    (function initLogo(){
      const img = document.getElementById('logoImg');
      if (!img) return;
      const saved = localStorage.getItem('np_logo');
      if (saved) img.src = saved;
      img.addEventListener('click', () => resetFiltersToHome());
    })();

    function getFavicon(url){
      try { return `https://www.google.com/s2/favicons?domain=${new URL(url).origin}&sz=128`; }
      catch { return 'https://via.placeholder.com/128x128.png?text=No+Image'; }
    }

    function twoSentences(s=''){
      let t = String(s)
        .replace(/<script[\s\S]*?<\/script>/gi,' ')
        .replace(/<style[\s\S]*?<\/style>/gi,' ')
        .replace(/<figure[\s\S]*?<\/figure>/gi,' ')
        .replace(/<[^>]*>/g,' ')
        .replace(/\s+/g,' ')
        .trim();
      const parts = t.split(/(?<=[.!?])\s+/);
      const clipped = parts.slice(0,2).join(' ');
      return clipped.length > 240 ? clipped.slice(0,237)+'…' : clipped;
    }

    function parseSheetDate(x){
      if (x === null || x === undefined) return null;
      const d1 = new Date(x);
      if (!isNaN(d1)) return d1;
      const n = Number(x);
      if (!isNaN(n)) {
        const ms = (n - 25569) * 86400000;
        const d2 = new Date(ms);
        if (!isNaN(d2)) return d2;
      }
      return null;
    }

    function sortNewest(items){
      return [...items].sort((a,b) => {
        const da = parseSheetDate(a.published_at) || new Date(0);
        const db = parseSheetDate(b.published_at) || new Date(0);
        return db - da;
      });
    }

    async function fetchNews({ filters = {}, since = null, q = '', limit = INITIAL_LIMIT } = {}){
      if (inFlightController) inFlightController.abort();
      inFlightController = new AbortController();

      const params = new URLSearchParams({
        limit: String(limit),
        min: '10',
        fallback: '1',
        t: Date.now().toString()
      });
      if (filters.language) params.append('language', filters.language);
      if (filters.category) params.append('category', filters.category);
      if (filters.country)  params.append('country',  filters.country);
      if (filters.city)     params.append('city',     filters.city);
      if (filters.sources && filters.sources.length){
        params.append('sources', filters.sources.join(','));
      }
      if (since) params.append('since', since);
      if (q)     params.append('q', q);

      const res = await fetch(`${API_URL}?${params.toString()}`, {
        cache: 'no-store',
        signal: inFlightController.signal
      });
      if (!res.ok) throw new Error(`API error: ${res.status}`);
      return await res.json();
    }

    async function fetchCategories(){
      const res = await fetch(`${API_URL}?fn=categories&t=${Date.now()}`, { cache: 'no-store' });
      if (!res.ok) throw new Error('No se pudieron cargar las categorías');
      return res.json(); // { categories: [...] }
    }

    async function fetchSources(){
      const res = await fetch(`${API_URL}?fn=sources&t=${Date.now()}`, { cache:'no-store' });
      if (!res.ok) throw new Error('No se pudieron cargar las fuentes');
      return res.json(); // { sources: [...] }
    }

    function populateCategorySelect(categories){
      const sel = document.getElementById('categorySelect');
      if (!sel) return;
      const current = sel.value;
      sel.innerHTML = `<option value="">Todas las categorías</option>`;
      (categories || []).forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
      });
      if (current && [...sel.options].some(o => o.value.toLowerCase() === current.toLowerCase())) {
        sel.value = current;
      }
    }

    function populateSourcesSelect(sources){
      const sel = document.getElementById('sourcesSelect');
      if (!sel) return;
      const prev = new Set((JSON.parse(localStorage.getItem(PREF_KEY) || '{}').sources) || []);
      sel.innerHTML = '';
      (sources || []).forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        opt.selected = prev.has(s);
        sel.appendChild(opt);
      });
    }

    function fmtDate(d){
      const dt = parseSheetDate(d);
      return !dt ? '' : dt.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'2-digit'});
    }

    function createCard(it){
      const hasImg  = it.image && String(it.image).trim();
      const imgHtml = hasImg
        ? `<img class="img" src="${it.image}" alt="" loading="lazy">`
        : `<div class="favicon-circle"><img src="${getFavicon(it.url)}" alt=""></div>`;

      const chipCat  = it.category ? `<span class="chip">${it.category}</span>` : '';
      const chipLang = it.language ? `<span class="chip">${String(it.language).toUpperCase()}</span>` : '';
      const chipLoc  = it.country ? `<span class="chip">${it.country}${it.city ? ' · ' + it.city : ''}</span>` : '';
      const source   = it.source ? `<span>${it.source}</span>` : '';
      const pub      = it.published_at ? `<span>${fmtDate(it.published_at)}</span>` : '';
      const excerpt  = twoSentences(it.summary || '');

      const card = document.createElement('article');
      card.className = 'card';
      card.innerHTML = `
        ${imgHtml}
        <div class="pad">
          <div class="title">
            <a href="${it.url}" target="_blank" rel="noopener" style="color:inherit;text-decoration:none;">
              ${it.title || ''}
            </a>
          </div>
          <div class="reason">${it.positivity_reason || ''}</div>
          <div class="meta">${chipCat} ${chipLang} ${chipLoc} ${source} ${pub}</div>
          <div class="excerpt">${excerpt}</div>
        </div>
      `;

      // acciones
      const actions = document.createElement('div');
      actions.style.display = 'flex';
      actions.style.gap = '10px';
      actions.style.marginTop = '10px';

      // Compartir
      const shareBtn = document.createElement('button');
      shareBtn.textContent = 'Compartir';
      shareBtn.className = 'chip';
      shareBtn.onclick = async () => {
        const text = `${it.title} — ${it.source || ''}`;
        const url  = it.url;
        try {
          if (navigator.share) {
            await navigator.share({ title: it.title, text, url });
          } else {
            const wa = `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`;
            window.open(wa, '_blank');
          }
        } catch (e) {}
      };
      actions.appendChild(shareBtn);

      // Like
      const likesLocal = getLikesLocal();
      const keyLike = it.dedup || it.url;
      const liked = likesLocal.has(keyLike);
      const likeBtn = document.createElement('button');
      likeBtn.textContent = liked ? '❤️ Te gusta' : '🤍 Me gusta';
      likeBtn.className = 'chip';
      likeBtn.onclick = async () => {
        const nowSet = getLikesLocal();
        if (nowSet.has(keyLike)) return;
        nowSet.add(keyLike);
        setLikesLocal(nowSet);
        likeBtn.textContent = '❤️ Te gusta';
        const params = new URLSearchParams({
          fn: 'like',
          dedup: keyLike,
          url: it.url,
          title: it.title || '',
          source: it.source || '',
          device: DEVICE_ID,
          t: Date.now().toString()
        });
        fetch(`${API_URL}?${params.toString()}`, { method: 'GET', cache: 'no-store' }).catch(()=>{});
      };
      actions.appendChild(likeBtn);

      // Leer después (24h)
      const laterBtn = document.createElement('button');
      laterBtn.textContent = '📌 Leer después';
      laterBtn.className = 'chip';
      laterBtn.onclick = () => {
        const obj = getLater();
        const key = it.dedup || it.url;
        const until = Date.now() + 24*60*60*1000;
        obj[key] = until;
        setLater(obj);
        laterBtn.textContent = '📌 Guardado (24h)';
      };
      actions.appendChild(laterBtn);

      card.querySelector('.pad').appendChild(actions);
      return card;
    }

    async function renderIncremental(items, q=''){
      const list  = document.getElementById('list');
      const empty = document.getElementById('empty');
      if (!list || !empty) return;

      list.innerHTML = '';
      const filtered = q ? items.filter(it => (it.title||'').toLowerCase().includes(q.toLowerCase())) : items;

      if (!filtered.length) {
        empty.style.display = 'block';
        empty.textContent = 'No hay resultados con este filtro.';
        return;
      }
      empty.style.display = 'none';

      const BATCH = 8;
      for (let i = 0; i < filtered.length; i++){
        list.appendChild(createCard(filtered[i]));
        if ((i+1) % BATCH === 0) {
          await new Promise(r => requestAnimationFrame(r));
        }
      }
    }

    async function applyFilters({ fullReload = false } = {}){
      try {
        const get = (id) => (document.getElementById(id)?.value || '').trim();
        const selectedSources = Array.from(document.getElementById('sourcesSelect')?.selectedOptions || []).map(o=>o.value);
        const filters = {
          language: get('langSelect'),
          category: get('categorySelect'),
          country:  get('countrySelect'),
          city:     get('citySelect'),
          sources:  selectedSources
        };
        const q = get('q');
        saveFilters();

        const quick = await fetchNews({
          filters,
          since: (!fullReload && lastSeenUpdate) ? lastSeenUpdate : null,
          q,
          limit: INITIAL_LIMIT
        });

        if (!lastSeenUpdate || quick.last_updated !== lastSeenUpdate || fullReload){
          const quickSorted = sortNewest(quick.items || []);
          await renderIncremental(quickSorted, q);
          lastSeenUpdate = quick.last_updated;
        }

        const full = await fetchNews({ filters, q, limit: FULL_LIMIT });
        const fullSorted = sortNewest(full.items || []);
        await renderIncremental(fullSorted, q);

      } catch (err){
        if (err.name === 'AbortError') return;
        console.error(err);
        const empty = document.getElementById('empty');
        if (empty){
          empty.style.display = 'block';
          empty.textContent = 'No pudimos cargar la API. Revisa la conexión.';
        }
      }
    }

    function scheduleApply(){
      if (applyTimer) clearTimeout(applyTimer);
      applyTimer = setTimeout(() => applyFilters({ fullReload: true }), 2000); // auto 2s
    }

    // ======== Racha de lectura (usuario) ========
    const STREAK_KEY = 'np_streak';
    const LAST_KEY   = 'np_lastVisit';
    const TOTAL_KEY  = 'np_totalDays';
    function updateStreak(){
      const todayStr = new Date().toDateString();
      const last = localStorage.getItem(LAST_KEY);
      let streak = Number(localStorage.getItem(STREAK_KEY) || 0);
      let total  = Number(localStorage.getItem(TOTAL_KEY) || 0);

      if (last !== todayStr) {
        total += 1;
        const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
        streak = (last === yesterday.toDateString()) ? (streak + 1) : 1;
        localStorage.setItem(LAST_KEY, todayStr);
        localStorage.setItem(STREAK_KEY, String(streak));
        localStorage.setItem(TOTAL_KEY, String(total));
      }
      document.getElementById('daysTotal').textContent  = String(Number(localStorage.getItem(TOTAL_KEY)||0));
      document.getElementById('daysStreak').textContent = String(Number(localStorage.getItem(STREAK_KEY)||0));
    }

    async function refreshHappyBar(){
      try {
        const res = await fetch(`${API_URL}?fn=stats&t=${Date.now()}`, { cache:'no-store' });
        const json = await res.json();
        const total = json.total_visits ?? 0;
        document.getElementById('happyBar').textContent = `Haciendo feliz a ${total} personas (total histórico)`;
      } catch {
        // ignore
      }
    }

    // ======== Eventos iniciales ========
    document.addEventListener('DOMContentLoaded', async () => {
      // Log de visita (para total histórico)
      (async () => {
        const params = new URLSearchParams({ fn:'visit', device: DEVICE_ID, t: Date.now().toString() });
        fetch(`${API_URL}?${params.toString()}`, { method:'GET', cache:'no-store' }).catch(()=>{});
      })();

      // Streak usuario
      updateStreak();

      // Cargar catálogos y preferencias
      try {
        const [{categories},{sources}] = await Promise.all([fetchCategories(), fetchSources()]);
        populateCategorySelect(categories || []);
        populateSourcesSelect(sources || []);
      } catch(e) {
        console.warn('No se pudieron cargar catálogos dinámicos:', e);
      }

      loadFilters();

      // Listeners para auto-aplicar + guardar prefs
      ['langSelect','categorySelect','countrySelect','citySelect','q','sourcesSelect'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const ev = (id === 'q') ? 'input' : 'change';
        el.addEventListener(ev, () => { saveFilters(); scheduleApply(); });
      });

      // Botón aplicar
      document.getElementById('apply')?.addEventListener('click', () => applyFilters({ fullReload: true }));

      // Sugerir fuente (URL única)
      const msg  = document.getElementById('proposeMsg');
      document.getElementById('btnSuggest')?.addEventListener('click', async () => {
        const rss = document.getElementById('p_rss').value.trim();
        if (!rss) { msg.textContent = 'Pega la URL RSS para sugerirla.'; return; }
        const params = new URLSearchParams({ fn:'propose_source', rss_url:rss, t:Date.now().toString() });
        try {
          const res = await fetch(`${API_URL}?${params.toString()}`, { method:'GET', cache:'no-store' });
          if (!res.ok) throw new Error('fail');
          msg.textContent = '¡Gracias! Revisaremos tu fuente.';
          document.getElementById('p_rss').value = '';
        } catch {
          msg.textContent = 'No pudimos enviar la propuesta ahora.';
        }
        setTimeout(()=> msg.textContent='', 4000);
      });

      // Ver “Leer después” y volver
      document.getElementById('btnLater')?.addEventListener('click', async () => {
        cleanupLater();
        const map = getLater();
        const keys = new Set(Object.keys(map));
        try {
          const res = await fetch(`${API_URL}?limit=200&t=${Date.now()}`, { cache:'no-store' });
          const json = await res.json();
          const items = (json.items || []).filter(it => keys.has(it.dedup || it.url));
          await renderIncremental(items, '');
          window.scrollTo({ top: 0, behavior: 'smooth' });
          inLaterView = true;
          document.getElementById('btnBackAll').style.display = 'inline-block';
        } catch {}
      });

      document.getElementById('btnBackAll')?.addEventListener('click', () => {
        inLaterView = false;
        document.getElementById('btnBackAll').style.display = 'none';
        applyFilters({ fullReload: true });
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      // Primera carga y refrescos
      await applyFilters({ fullReload: true });
      setInterval(() => { if (!inLaterView) applyFilters({ fullReload: false }); }, REFRESH_MS);

      // Footer (total histórico)
      refreshHappyBar();
      setInterval(refreshHappyBar, 180000);
    });
  </script>
</body>
</html>
