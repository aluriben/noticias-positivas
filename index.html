<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Noticias Positivas</title>
  <meta name="description" content="Agregador de noticias positivas por categoría y país, con filtros, búsqueda y auto‑refresh." />
  <style>
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937; --surface:#0b1220; --accent:#22c55e; }
    * { box-sizing:border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; background:var(--bg); color:var(--text);}
    header { padding:16px 0; border-bottom:1px solid var(--border); position:sticky; top:0; background:rgba(15,23,42,.9); backdrop-filter:blur(6px); z-index:10; }
    .wrap { max-width:1200px; margin:0 auto; padding:0 16px; }
    .topbar { display:flex; align-items:center; gap:14px; }
    .logo img { width:36px; height:36px; border-radius:8px; object-fit:cover; background:var(--surface); cursor:pointer; }
    .brand { font-weight:700; letter-spacing:.2px; }
    .sub { font-size:12px; color:var(--muted); }
    .controls { margin-top:10px; display:grid; gap:10px; grid-template-columns:repeat(5,1fr) auto; }
    .controls select,.controls input,.controls button { padding:10px; border-radius:10px; border:1px solid var(--border); background:var(--surface); color:var(--text);}
    .btn { cursor:pointer; background:var(--card); }
    main { padding:18px 0 60px; }
    .grid { display:grid; gap:16px; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden; display:flex; flex-direction:column; transition:transform .12s ease; }
    .card:hover { transform: translateY(-2px);}
    .img { width:100%; aspect-ratio:16/9; object-fit:cover; background:var(--surface);}
    .favicon-circle { display:flex; justify-content:center; align-items:center; background:var(--surface); height:calc(9*(100%/16)); }
    .favicon-circle img { width:64px; height:64px; border-radius:50%; background:#fff; padding:6px; box-shadow:0 0 8px rgba(0,0,0,.25);}
    .pad { padding:14px; }
    .title { font-weight:600; line-height:1.3; }
    .meta { font-size:12px; color:var(--muted); margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; }
    .chip { background:#1f2937; padding:2px 8px; border-radius:999px; }
    .reason { color:var(--accent); font-size:13px; margin-top:8px; }
    .excerpt { color:var(--muted); font-size:14px; margin-top:8px; line-height:1.5; }
    .empty { text-align:center; color:var(--muted); padding:40px 0; }
    footer { text-align:center; color:var(--muted); padding:24px; border-top:1px solid var(--border); }
    @media (max-width:900px) { .controls { grid-template-columns:1fr 1fr 1fr; } }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="logo">
        <img id="logoImg" src="./assets/logo.svg" alt="Logo" title="Haz clic para cambiar el logo (URL)">
      </div>
      <div>
        <div class="brand">Noticias <span style="color:var(--accent)">Positivas</span></div>
        <div class="sub">Auto‑refresh cada 5 min · Completa hasta 10 resultados por filtro/búsqueda (histórico)</div>
      </div>
    </div>
    <div class="controls">
      <select id="categorySelect" title="Categoría">
        <option value="">Todas las categorías</option>
        <option>Política</option><option>Deporte</option><option>Finanzas</option><option>Economía</option>
        <option>Turismo</option><option>Promos de aerolíneas</option><option>Tecnología</option><option>Negocios</option>
        <option>Sostenibilidad</option><option>Emprendimiento social</option><option>Salud</option><option>General Global</option>
      </select>
      <input id="countrySelect" placeholder="País (ISO-2, ej. CO, US)">
      <input id="citySelect" placeholder="Ciudad (opcional)">
      <input id="q" placeholder="Buscar en títulos...">
      <button class="btn" id="apply">Aplicar</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="list" class="grid"></div>
  <div id="empty" class="empty" style="display:none;">No encontramos noticias con esos filtros.</div>
</main>
<footer>Hecho con ❤️ para equilibrar el feed del mundo.</footer>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxfrs6JokQgtjjf4HMVAiyXqOd0NiwnWhOM0OeiaGkw51tXIMed4mDrEQfBWGY2VCYv/exec";
  const REFRESH_MS = 300000;
  let lastSeenUpdate = null;

  (function initLogo(){
    const img = document.getElementById('logoImg');
    const saved = localStorage.getItem('np_logo');
    if (saved) img.src = saved;
    img.addEventListener('click', () => {
      const url = prompt('Pega la URL de tu logo (PNG/JPG/SVG):', saved || '');
      if (url) { localStorage.setItem('np_logo', url); img.src = url; }
    });
  })();

  function getFavicon(url){
    try { return `https://www.google.com/s2/favicons?domain=${new URL(url).origin}&sz=128`; }
    catch { return 'https://via.placeholder.com/128x128.png?text=No+Image'; }
  }

  function twoSentences(s=''){
    let t = String(s)
      .replace(/<script[\s\S]*?<\/script>/gi,' ')
      .replace(/<style[\s\S]*?<\/style>/gi,' ')
      .replace(/<figure[\s\S]*?<\/figure>/gi,' ')
      .replace(/<[^>]*>/g,' ')
      .replace(/\s+/g,' ')
      .trim();
    const parts = t.split(/(?<=[.!?])\s+/);
    const clipped = parts.slice(0,2).join(' ');
    return clipped.length > 240 ? clipped.slice(0,237)+'…' : clipped;
  }

  async function fetchNews(filters={{}}, opts={{}}, q=''){
    const params = new URLSearchParams({ limit:60, min:10, fallback:1 });
    if (filters.category) params.append('category', filters.category);
    if (filters.country)  params.append('country',  filters.country);
    if (filters.city)     params.append('city',     filters.city);
    if (opts.since)       params.append('since',    opts.since);
    if (q)                params.append('q',        q);
    const res = await fetch(`${{API_URL}}?${{params.toString()}}`);
    if (!res.ok) throw new Error('API error');
    return await res.json();
  }

  function fmtDate(d){
    const dt = new Date(d);
    return isNaN(dt) ? '' : dt.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'2-digit'});
  }

  function render(items, q=''){
    const list = document.getElementById('list');
    const empty = document.getElementById('empty');
    list.innerHTML='';
    const filtered = q ? items.filter(it=> (it.title||'').toLowerCase().includes(q.toLowerCase())) : items;
    if (!filtered.length) { empty.style.display='block'; return; }
    empty.style.display='none';
    for (const it of filtered){
      const hasImg = it.image && it.image.trim();
      const imgHtml = hasImg ? `<img class="img" src="${{it.image}}" alt="">`
                             : `<div class="favicon-circle"><img src="${{getFavicon(it.url)}}" alt=""></div>`;
      const card = document.createElement('article');
      card.className = 'card';
      card.innerHTML = `
        ${{imgHtml}}
        <div class="pad">
          <div class="title"><a href="${{it.url}}" target="_blank" rel="noopener" style="color:inherit;text-decoration:none;">${{it.title||''}}</a></div>
          <div class="reason">${{it.positivity_reason||''}}</div>
          <div class="meta">
            ${{it.category ? `<span class='chip'>${{it.category}}</span>` : ''}}
            ${{it.country ? `<span class='chip'>${{it.country}}${{it.city ? ' · ' + it.city : ''}}</span>` : ''}}
            ${{it.source ? `<span>${{it.source}}</span>` : ''}}
            ${{it.published_at ? `<span>${{fmtDate(it.published_at)}}</span>` : ''}}
          </div>
          <div class="excerpt">${{twoSentences(it.summary||'')}}</div>
        </div>`;
      list.appendChild(card);
    }
  }

  async function applyFilters(fullReload=false){
    try {
      const filters = {
        category: document.getElementById('categorySelect').value.trim(),
        country:  document.getElementById('countrySelect').value.trim(),
        city:     document.getElementById('citySelect').value.trim()
      };
      const q = document.getElementById('q').value.trim();
      const opts = (!fullReload && lastSeenUpdate) ? { since: lastSeenUpdate } : {};
      const data = await fetchNews(filters, opts, q);
      if (!lastSeenUpdate || data.last_updated !== lastSeenUpdate || fullReload){
        const full = await fetchNews(filters, {}, q);
        render(full.items||[], q);
        lastSeenUpdate = data.last_updated;
      }
    } catch(err){
      console.error(err);
      document.getElementById('empty').style.display='block';
      document.getElementById('empty').textContent='No pudimos cargar la API. Revisa la URL en el código.';
    }
  }

  document.getElementById('apply').addEventListener('click', ()=>applyFilters(true));
  applyFilters(true);
  setInterval(()=>applyFilters(false), REFRESH_MS);
</script>
</body>
</html>
